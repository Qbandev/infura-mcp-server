name: Manual NPM Publish (Backup)

# Manual workflow for publishing to npm
# Uses npm Trusted Publishing with OIDC (recommended since Dec 2025)
# See: https://github.blog/changelog/2025-12-09-npm-classic-tokens-revoked-session-based-auth-and-cli-token-management-now-available/

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to publish (e.g., v1.0.0)'
        required: true
        type: string
      npm_tag:
        description: 'NPM dist-tag (latest, beta, next)'
        required: false
        default: 'latest'
        type: string

permissions:
  contents: read
  id-token: write  # Required for npm OIDC trusted publishing

jobs:
  authorize:
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.auth-check.outputs.authorized }}
    steps:
      - name: Check authorization
        id: auth-check
        run: |
          AUTHORIZED_USERS="Qbandev"
          REPO_OWNER="${{ github.repository_owner }}"
          ACTOR="${{ github.actor }}"

          echo "Repository owner: $REPO_OWNER"
          echo "Workflow actor: $ACTOR"

          if [ "$ACTOR" = "$REPO_OWNER" ]; then
            echo "âœ… Authorized: Repository owner"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          for user in $AUTHORIZED_USERS; do
            if [ "$ACTOR" = "$user" ]; then
              echo "âœ… Authorized: Listed user"
              echo "authorized=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "âŒ Unauthorized: $ACTOR"
          echo "authorized=false" >> $GITHUB_OUTPUT
          exit 1

  publish:
    runs-on: ubuntu-latest
    needs: authorize
    if: needs.authorize.outputs.authorized == 'true'
    permissions:
      contents: read
      id-token: write  # Required for npm OIDC trusted publishing
    
    environment:
      name: npm
      url: https://www.npmjs.com/package/infura-mcp-server

    steps:
      - name: Checkout code at tag
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Verify tag matches package version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ github.event.inputs.tag }}"
          TAG_VERSION=${TAG_VERSION#v}
          
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: Package version ($PACKAGE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          
          echo "âœ… Version verified: $PACKAGE_VERSION"

      - name: Run tests before publish
        env:
          INFURA_API_KEY: ${{ secrets.INFURA_API_KEY }}
        run: npm test

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check if already published
        id: check-published
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          NPM_VERSION=$(npm view infura-mcp-server@$PACKAGE_VERSION version 2>/dev/null || echo "")
          
          if [ -n "$NPM_VERSION" ]; then
            echo "âš ï¸ Version $PACKAGE_VERSION already published"
            echo "already-published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $PACKAGE_VERSION not yet published"
            echo "already-published=false" >> $GITHUB_OUTPUT
          fi

      # npm Trusted Publishing with OIDC (Dec 2025+)
      # No NPM_TOKEN needed - authentication via OIDC
      # Configured at: npmjs.com/package/infura-mcp-server/access
      - name: Publish to npm with provenance (OIDC)
        if: steps.check-published.outputs.already-published == 'false'
        run: npm publish --provenance --access public --tag ${{ github.event.inputs.npm_tag }}

      - name: Create publish summary
        if: always()
        run: |
          echo "## ðŸ“¦ Manual NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Tag**: ${{ github.event.inputs.npm_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-published.outputs.already-published }}" == "true" ]; then
            echo "âš ï¸ **Status**: Version already published, skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status**: Published with npm provenance attestation" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” npm Authentication (Dec 2025+)" >> $GITHUB_STEP_SUMMARY
          echo "Using OIDC trusted publishing or granular access token." >> $GITHUB_STEP_SUMMARY
          echo "Classic npm tokens were revoked on Dec 9, 2025." >> $GITHUB_STEP_SUMMARY
          echo "See: https://docs.npmjs.com/trusted-publishers" >> $GITHUB_STEP_SUMMARY
