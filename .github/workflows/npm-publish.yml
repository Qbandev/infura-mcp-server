name: Manual NPM Publish (Backup)

# Manual workflow for publishing to npm
# Uses npm Trusted Publishing with OIDC (recommended since Dec 2025)
# See: https://github.blog/changelog/2025-12-09-npm-classic-tokens-revoked-session-based-auth-and-cli-token-management-now-available/

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to publish (e.g., v1.0.0)'
        required: true
        type: string
      npm_tag:
        description: 'NPM dist-tag'
        required: false
        default: 'latest'
        type: choice
        options:
          - latest
          - beta
          - next

permissions:
  contents: read
  id-token: write  # Required for npm OIDC trusted publishing

jobs:
  authorize:
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.auth-check.outputs.authorized }}
    steps:
      - name: Check authorization
        id: auth-check
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          ACTOR: ${{ github.actor }}
        run: |
          AUTHORIZED_USERS="Qbandev"

          echo "Repository owner: $REPO_OWNER"
          echo "Workflow actor: $ACTOR"

          if [ "$ACTOR" = "$REPO_OWNER" ]; then
            echo "âœ… Authorized: Repository owner"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          for user in $AUTHORIZED_USERS; do
            if [ "$ACTOR" = "$user" ]; then
              echo "âœ… Authorized: Listed user"
              echo "authorized=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "âŒ Unauthorized: $ACTOR"
          echo "authorized=false" >> $GITHUB_OUTPUT
          exit 1

  publish:
    runs-on: ubuntu-latest
    needs: authorize
    if: needs.authorize.outputs.authorized == 'true'
    permissions:
      contents: read
      id-token: write  # Required for npm OIDC trusted publishing
    
    environment:
      name: npm
      url: https://www.npmjs.com/package/infura-mcp-server

    steps:
      - name: Validate tag format
        env:
          GIT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if ! echo "$GIT_TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Invalid tag format. Expected format: v1.0.0 or v1.0.0-beta.1"
            exit 1
          fi
          echo "Tag format validated: $GIT_TAG"

      - name: Checkout code at tag
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          # registry-url removed for npm OIDC authentication

      - name: Upgrade npm for OIDC support
        run: npm install -g npm@11.7.0
        # npm 11.5+ required for OIDC authentication

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Verify tag matches package version
        env:
          GIT_TAG: ${{ github.event.inputs.tag }}
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="$GIT_TAG"
          TAG_VERSION=${TAG_VERSION#v}
          
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: Package version ($PACKAGE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          
          echo "âœ… Version verified: $PACKAGE_VERSION"

      - name: Run tests before publish
        env:
          INFURA_API_KEY: ${{ secrets.INFURA_API_KEY }}
        run: npm test

      - name: Security audit
        id: security-audit
        run: |
          npm audit --audit-level=high
          echo "audit_passed=true" >> $GITHUB_OUTPUT

      - name: Verify security audit passed
        if: steps.security-audit.outputs.audit_passed != 'true'
        run: |
          echo "Security audit failed. Cannot proceed with publish."
          exit 1

      - name: Check if already published
        id: check-published
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          NPM_VERSION=$(npm view infura-mcp-server@$PACKAGE_VERSION version 2>/dev/null || echo "")
          
          if [ -n "$NPM_VERSION" ]; then
            echo "âš ï¸ Version $PACKAGE_VERSION already published"
            echo "already-published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $PACKAGE_VERSION not yet published"
            echo "already-published=false" >> $GITHUB_OUTPUT
          fi

      # npm Trusted Publishing with OIDC (Dec 2025+)
      # OIDC authentication (no token needed)
      # Configured at: npmjs.com/package/infura-mcp-server/access
      - name: Publish to npm with provenance
        if: steps.check-published.outputs.already-published == 'false'
        env:
          NPM_TAG: ${{ github.event.inputs.npm_tag }}
        run: npm publish --provenance --access public --tag "$NPM_TAG"
        # Note: No NODE_AUTH_TOKEN needed - OIDC handles authentication automatically

      - name: Create publish summary
        if: always()
        env:
          GIT_TAG: ${{ github.event.inputs.tag }}
          NPM_TAG: ${{ github.event.inputs.npm_tag }}
          ACTOR: ${{ github.actor }}
          ALREADY_PUBLISHED: ${{ steps.check-published.outputs.already-published }}
        run: |
          echo "## Manual NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $GIT_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Tag**: $NPM_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: $ACTOR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$ALREADY_PUBLISHED" == "true" ]; then
            echo "**Status**: Version already published, skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: Published with npm provenance attestation" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” npm Authentication (Dec 2025+)" >> $GITHUB_STEP_SUMMARY
          echo "Using OIDC trusted publishing or granular access token." >> $GITHUB_STEP_SUMMARY
          echo "Classic npm tokens were revoked on Dec 9, 2025." >> $GITHUB_STEP_SUMMARY
          echo "See: https://docs.npmjs.com/trusted-publishers" >> $GITHUB_STEP_SUMMARY
